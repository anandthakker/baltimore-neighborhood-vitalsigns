(function(){angular.module("vitalsigns",["ui.router"]).config(["$stateProvider","$urlRouterProvider",function(t,e){return t.state("main",{url:"/i/:indicators/c/:communities","abstract":!0,templateUrl:"partials/main.tpl.html",resolve:{indicatorSelection:["$location","$rootScope","$stateParams","Selection",function(t,e,n,i){var r;return r=new i(n.indicators),r.onChange=function(){var n,i;return e.skipStateChange=!0,n=t.path(),i=n.replace(/\/i\/[^\/]*\//,"/i/"+this.toString()+"/"),t.path(i)},r}],communitySelection:["$location","$rootScope","$stateParams","Selection",function(t,e,n,i){var r,o,a;return r=function(t){return t.replace(/-/g,"-~").replace(/\//g,"--").replace(/\s/g,"-_")},a=function(t){return t.replace(/-_/g," ").replace(/--/g,"/").replace(/-~/g,"-")},o=new i(a(n.communities)),o.onChange=function(){var n,i;return e.skipStateChange=!0,n=t.path(),i=n.replace(/\/c\/[^\/]*\//,"/c/"+r(this.toString())+"/"),t.path(i)},o}],dataset:"vsData"}}).state("main.multiples",{url:"/",views:{controls:{templateUrl:"partials/controls.tpl.html",controller:"controls"},multiples:{templateUrl:"partials/multiples.tpl.html",controller:"multiples"},comments:{template:""}}}),e.otherwise("/i//c//"),e.deferIntercept()}]).run(["$rootScope","$urlRouter",function(t,e){return t._=_,t.$on("$locationChangeSuccess",function(e){return t.skipStateChange?(t.skipStateChange=!1,e.preventDefault()):void 0}),e.listen()}]).controller("controls",["$scope","dataset","indicatorSelection",function(t,e,n){var i;return t.varInfo=e.varInfo,t.indicators=_(e.varInfo.values()).filter(function(t){return _.contains(e.variables,t["Variable Name"])}).groupBy("Section").value(),t.clear=function(){return n.clear()},t.isSelected=function(t){return n.isSelected(t["Variable Name"])},t.select=function(t){return n.select(_.isArray(t)?_.pluck(variables,"Variable Name"):t["Variable Name"])},i=null,t.startDragSelect=function(e){return t.select(e),t.isSelected(e)?i=e:void 0},t.endDragSelect=function(){return i=null},t.dragSelect=function(e,r){var o,a,s,u,c;if(null!=i){for(a=1+_(t.indicators[e]).indexOf(i),s=_(t.indicators[e]).indexOf(r),c=[],o=u=a;s>=a?s>=u:u>=s;o=s>=a?++u:--u)c.push(n.add(t.indicators[e][o]["Variable Name"]));return c}}}]).controller("multiples",["$scope","dataset","indicatorSelection","communitySelection",function(t,e,n,i){return t.vitalsigns=e.vitalsigns,t.varInfo=e.varInfo,t.selection=n,t.communitySelection=i,t.showCommunity=function(e,n){return t.showCommunities(null!=e?[e]:[],n)},t.showCommunities=function(e,n){return t.activeCommunities=null!=e?e:[],t.currentIndicator=n,t.currentCommunity=1===(null!=e?e.length:void 0)?e[0]:null},t.selectCommunity=function(e){return t.communitySelection.select(e)},t.selectCommunities=function(e){return t.communitySelection.select(e),t.activeCommunities=[]},t.moveLeft=function(e){var i,r;return i=_.indexOf(t.selection.selectedValues,e),r=t.selection.selectedValues[i],n.selectedValues[i]=t.selection.selectedValues[i-1],n.selectedValues[i-1]=r,n.onChange()},t.moveRight=function(e){var i,r;return i=_.indexOf(t.selection.selectedValues,e),r=t.selection.selectedValues[i],n.selectedValues[i]=t.selection.selectedValues[i+1],n.selectedValues[i+1]=r,n.onChange()}}])}).call(this),function(){angular.module("vitalsigns").factory("vsData",["$q",function(t){var e,n,i,r;return e=t.defer(),r={topojson:null,codebook:null,vitalsigns:d3.map(),variables:[],varInfo:d3.map(),getIndicatorValue:function(t,e){var n,i;return n=null!=(i=r.vitalsigns.get(t))?i.get(e):void 0,n=(null!=n?n:"").replace(/[$,]/,""),parseFloat(n)},getAllRelatedIndicators:function(t){return _(r.varInfo).where({Indicator:r.varInfo.get(t).Indicator}).pluck("Variable Name").value()}},d3.json("data/csa_2010_boundaries/CSA_NSA_Tracts.topo.json",function(t,n){if(t)throw e.reject(t),new Error(t);return r.topojson=n,d3.csv("data/Vital Signs Codebook and Sources - Variables and Sources.csv",function(t){return t},function(t,n){var i,o,a,s,u,c,l,h,d,f,p,v;if(t)throw e.reject(t),new Error(t);for(r.codebook=n,v=r.codebook,h=0,f=v.length;f>h;h++)for(a=v[h],s=a["Variable Name"],s=s.substring(0,s.length-2),l=function(){var t,e;for(e=[],u=t=2007;2013>=t;u=++t)e.push(u);return e}(),o=function(t,e){return(1e15+t+"").slice(-e)},d=0,p=l.length;p>d;d++)u=l[d],c=o(u-2e3,2),i=angular.extend({Year:u},a),i["Variable Name"]=s+c,r.varInfo.set(s+c,i);return e.resolve(r)})}),i=function(t){var e,n,i;if(e=t.CSA2010,"Baltimore City"!==e){r.vitalsigns.has(e)||r.vitalsigns.set(e,d3.map());for(n in t)i=t[n],"CSA2010"!==n&&r.vitalsigns.get(e).set(n,i);return t}},n=function(t,e){var n,i,o,a;if(t)throw new Error(t);o=e[0],a=[];for(n in o)i=o[n],a.push("CSA2010"!==n?r.variables.push(n):void 0);return a},d3.csv("data/VS Arts 2011-2012 - VS Arts 2010-2012.csv",i,n),d3.csv("data/VS Census 2010-2012 - VS Census 2010-2012.csv",i,n),d3.csv("data/VS Crime 2010-2012 - VS Crime 2010-2012.csv",i,n),d3.csv("data/VS Education 2010-2012 - VS Education 2010-2012.csv",i,n),d3.csv("data/VS Health 2010-2012 - VS_Health_2010-2012.csv",i,n),d3.csv("data/VS Housing 2010-2012 - VS Housing 2010-2012.csv",i,n),d3.csv("data/VS Sustainability 2010-2012 - VS Sustainability 2010-2012.csv",i,n),d3.csv("data/VS Workforce 2010-2012 - VS Workforce 2010-2012.csv",i,n),e.promise}])}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("vitalsigns").factory("Selection",function(){var e;return e=function(){function e(e,n){this.clear=t(this.clear,this),this.select=t(this.select,this),this.isSelected=t(this.isSelected,this),this.toggle=t(this.toggle,this),this.remove=t(this.remove,this),this.add=t(this.add,this),this.toString=t(this.toString,this),this.parse=t(this.parse,this),this.selectedValues=[],this.parse(e,n)}return e.prototype.parse=function(t,e){return(null!=t&&"function"==typeof t.trim?t.trim().length:void 0)>0?this.selectedValues=t.split(null!=e?e:":"):void 0},e.prototype.toString=function(t){var e;return(null!=(e=this.selectedValues)?e:[]).join(null!=t?t:":")},e.prototype.add=function(t){return this.isSelected(t)?void 0:(this.selectedValues.push(t),this.onChange())},e.prototype.remove=function(t){var e;return e=_.indexOf(this.selectedValues,t),e>=0?(this.selectedValues.splice(e,1),this.onChange()):void 0},e.prototype.toggle=function(t){return this.isSelected(t)?this.remove(t):this.add(t)},e.prototype.isSelected=function(t){return _.contains(this.selectedValues,t)},e.prototype.select=function(t){var e,n;return _.isArray(t)?(n=this.onChange,e=!1,this.onChange=function(){return e=!0},_.some(t,function(t){return function(e){return!t.isSelected(e)}}(this))?_.map(t,this.add):_.map(t,this.remove),this.onChange=n,e?this.onChange():void 0):this.toggle(t)},e.prototype.clear=function(){return this.selectedValues=[],this.onChange()},e.prototype.onChange=function(){},e}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("vitalsigns").factory("Choropleth",function(){var e;return e=function(){function e(e,n){this.feature=n,this.redraw=t(this.redraw,this),this.data=t(this.data,this),this.colorRange=t(this.colorRange,this),this.domain=t(this.domain,this),this.click=t(this.click,this),this.hover=t(this.hover,this),this.svg=d3.select(e),this.projection=d3.geo.mercator().scale(5e4).center([-76.6167,39.2833]).translate([this.width/2,this.height/2]),this.path=d3.geo.path().projection(this.projection)}return e.prototype.width=200,e.prototype.height=200,e.prototype._mouseover=function(){},e.prototype._mouseout=function(){},e.prototype.hover=function(t){return null!=t?(this._mouseover=t[0],this._mouseout=t[1],this):[this._mouseover,this._mouseout]},e.prototype._click=function(){},e.prototype.click=function(t){return null!=t?this._click=t:this._click},e.prototype.value=function(t){return this._data[t]},e.prototype.domain=function(){return d3.extent(this._data,this.value)},e.prototype.colorRange=function(){return d3.range(9).map(function(t){return"q"+t+"-9"})},e.prototype.data=function(t,e){return this.topojsonData=t,this._data=e,this.redraw()},e.prototype.redraw=function(){var t,e;return t=this.topojsonData.objects[this.feature],e=d3.scale.quantize().domain(this.domain()).range(this.colorRange()),this.svg.attr("width",this.width).attr("height",this.height),this.svg.selectAll(".region").data(topojson.feature(this.topojsonData,t).features).enter().append("path").attr("d",this.path).attr("data-region",function(t){return t.id}).attr("class",function(t){return function(n){var i;return i=e(t.value(n)),"region "+i}}(this)).on("mouseover",function(t){return function(e,n){return t._mouseover(e,n)}}(this)).on("mouseout",function(t){return function(e,n){return t._mouseout(e,n)}}(this)).on("click",function(t){return function(e,n){return t._click(e,n)}}(this)),this.svg.append("path").datum(topojson.mesh(this.topojsonData,t)).attr("d",this.path).attr("class","region-boundary")},e}()}).factory("Histogram",function(){var e;return e=function(){function e(e){this.redraw=t(this.redraw,this),this.data=t(this.data,this),this.colorRange=t(this.colorRange,this),this.domain=t(this.domain,this),this.value=t(this.value,this),this.click=t(this.click,this),this.hover=t(this.hover,this),this.svg=d3.select(e)}return e.prototype.width=200,e.prototype.height=100,e.prototype._mouseover=function(){},e.prototype._mouseout=function(){},e.prototype.hover=function(t){return null!=t?(this._mouseover=t[0],this._mouseout=t[1],this):[this._mouseover,this._mouseout]},e.prototype._click=function(){},e.prototype.click=function(t){return null!=t?this._click=t:this._click},e.prototype.value=function(t){return this._data[t]},e.prototype.domain=function(){return d3.extent(this._data,this.value)},e.prototype.colorRange=function(){return d3.range(9).map(function(t){return"q"+t+"-9"})},e.prototype.data=function(t){return this._data=t,this.redraw()},e.prototype.redraw=function(){var t,e,n,i,r,o,a,s,u,c,l,h;return o={top:5,right:10,bottom:25,left:10},u=this.width-o.left-o.right,i=this.height-o.top-o.bottom,a=d3.scale.quantize().domain(this.domain()).range(this.colorRange()),c=d3.scale.linear().domain(this.domain()).range([0,u]),r=d3.layout.histogram().bins(c.ticks(10)).value(this.value),e=r(this._data),h=d3.scale.linear().domain([0,d3.max(e,function(){return function(t){return t.y}}(this))]).range([i,0]),l=d3.svg.axis().scale(c).ticks(5).orient("bottom"),n=this.svg.attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+o.left+","+o.top+")"),t=n.selectAll(".bar").data(e).enter().append("g").attr("class","bar").attr("transform",function(){return function(t){return"translate("+c(t.x)+","+h(t.y)+")"}}(this)),s=t.append("rect").attr("x",1).attr("width",c(e[0].dx)-c(0)).attr("height",function(){return function(t){return i-h(t.y)}}(this)).attr("class",function(){return function(t){return a(t.x)}}(this)).on("mouseover",function(t){return function(e,n){return t._mouseover(e,n)}}(this)).on("mouseout",function(t){return function(e,n){return t._mouseout(e,n)}}(this)).on("click",function(t){return function(e,n){return t._click(e,n)}}(this)),n.append("g").attr("class","axis").attr("transform","translate(0,"+i+")").call(l)},e}()}).factory("Scatter",function(){var e;return e=function(){function e(e){this.redraw=t(this.redraw,this),this.data=t(this.data,this),this.label=t(this.label,this),this.yDomain=t(this.yDomain,this),this.yValue=t(this.yValue,this),this.xDomain=t(this.xDomain,this),this.xValue=t(this.xValue,this),this.click=t(this.click,this),this.hover=t(this.hover,this),this.svg=d3.select(e),this.g=this.svg.append("g"),this.g.append("g").attr("class","x-axis axis"),this.g.append("g").attr("class","y-axis axis"),this.g.append("text").attr("class","x-axis-label axis-label"),this.g.append("text").attr("class","y-axis-label axis-label")}return e.prototype.width=400,e.prototype.height=400,e.prototype._mouseover=function(){},e.prototype._mouseout=function(){},e.prototype.hover=function(t){return null!=t?(this._mouseover=t[0],this._mouseout=t[1],this):[this._mouseover,this._mouseout]},e.prototype._click=function(){},e.prototype.click=function(t){return null!=t?this._click=t:this._click},e.prototype.xValue=function(t){return this._data[t][0]},e.prototype.xDomain=function(){return d3.extent(this._data,this.value)},e.prototype.xLabel="",e.prototype.yValue=function(t){return this._data[t][1]},e.prototype.yDomain=function(){return d3.extent(this._data,this.value)},e.prototype.yLabel="",e.prototype.label=function(t){return"("+this.xValue(t)+","+this.yValue(t)+")"},e.prototype.data=function(t){return this._data=t,this.redraw()},e.prototype.redraw=function(){var t,e,n,i,r,o,a,s,u;return e={top:5,right:5,bottom:50,left:50},r=this.width-e.left-e.right,t=this.height-e.top-e.bottom,o=d3.scale.linear().domain(this.xDomain()).range([0,r]),s=d3.scale.linear().domain(this.yDomain()).range([t,0]),a=d3.svg.axis().scale(o).ticks(5).orient("bottom"),u=d3.svg.axis().scale(s).ticks(5).orient("left"),this.svg.attr("width",this.width).attr("height",this.height),this.g.attr("transform","translate("+e.left+","+e.top+")"),n=this.g.selectAll(".point").data(this._data),n.enter().append("circle"),n.exit().remove(),n.attr("class","point").attr("r",6).attr("cx",function(t){return function(e){return o(t.xValue(e))}}(this)).attr("cy",function(t){return function(e){return s(t.yValue(e))}}(this)).on("mouseover",function(t){return function(e,n){return t._mouseover(e,n)}}(this)).on("mouseout",function(t){return function(e,n){return t._mouseout(e,n)}}(this)).on("click",function(t){return function(e,n){return t._click(e,n)}}(this)),i=this.g.selectAll(".label").data(this._data),i.enter().append("text"),i.exit().remove(),i.attr("class","label").attr("x",function(t){return function(e){return o(t.xValue(e))+5}}(this)).attr("y",function(t){return function(e){return s(t.yValue(e)+5)}}(this)).text(function(t){return function(e){return t.label(e)}}(this)),this.g.select(".x-axis").attr("transform","translate(0,"+(t+e.bottom-30)+")").call(a),this.g.select(".y-axis").call(u),this.g.select(".x-axis-label").text(this.xLabel).attr("x",r/2).attr("y",t+e.bottom-1).attr("text-anchor","middle"),this.g.select(".y-axis-label").text(this.yLabel).attr("transform","rotate(-90) translate("+-t/2+", "+(-e.left+10)+")").attr("text-anchor","middle")},e}()}).value("calculateExtent",function(t,e){var n,i,r;return i=t.getAllRelatedIndicators(e),r=_(t.vitalsigns.keys()).map(function(e){return i.map(function(n){return t.getIndicatorValue(e,n)})}).flatten().filter(function(t){return!isNaN(t)}).value(),n=d3.extent(r)}).directive("vsMap",["vsData","Choropleth","calculateExtent",function(t,e,n){return{template:"<div><svg></svg></div>",restrict:"E",replace:!0,scope:{hover:"=",click:"=",selected:"=",active:"="},link:function(i,r,o){return o.$observe("property",function(o){var a,s;return a=r.children("svg")[0],s=new e(a,"CSA_NSA_Tracts"),t.then(function(t){return i.varInfo=t.varInfo.get(o),s.value=function(e){return t.getIndicatorValue(e.id,o)},s.domain=function(){return n(t,o)},s.data(t.topojson,t.vitalsigns.keys()),s.hover([function(t){return i.$apply(function(){return i.hover(t.id,o)})},function(){return i.$apply(function(){return i.hover(null,null)})}]),s.click(function(t){return i.$apply(function(){return i.click(t.id)})}),i.$watch("active",function(t){return null!=t?d3.select(a).selectAll(".region").classed("active",function(t){return _.contains(i.active,t.id)}):void 0},!0),i.$watch("selected",function(t){return null!=t?d3.select(a).selectAll(".region").classed("selected",function(t){return _.contains(i.selected,t.id)}):void 0},!0)})})}}}]).directive("vsHistogram",["vsData","Histogram","calculateExtent",function(t,e,n){return{template:"<div><svg></svg></div>",restrict:"E",replace:!0,scope:{hover:"=",click:"=",selected:"=",active:"="},link:function(i,r,o){return o.$observe("property",function(o){var a,s;return s=r.children("svg")[0],a=new e(s),t.then(function(t){return i.varInfo=t.varInfo.get(o),a.value=function(e){return t.getIndicatorValue(e,o)},a.domain=function(){return n(t,o)},a.data(t.vitalsigns.keys()),a.hover([function(t){return i.$apply(function(){return i.hover(t,o)})},function(){return i.$apply(function(){return i.hover(null,null)})}]),a.click(function(t){return i.$apply(function(){return i.click(t)})}),i.$watch("active",function(t){return null!=t?d3.select(s).selectAll("rect").classed("active",function(e){return t.length>0&&_(t).every(function(t){return _(e).contains(t)})}):void 0},!0),i.$watch("selected",function(t){return null!=t?d3.select(s).selectAll("rect").classed("selected",function(e){return _(e).every(function(e){return _(t).contains(e)})}):void 0},!0)})})}}}]).directive("vsScatter",["vsData","Scatter","calculateExtent",function(t,e,n){return{template:"<div><svg></svg></div>",restrict:"E",replace:!0,scope:{hover:"=",click:"=",selected:"=",active:"=",indicators:"="},link:function(i,r){var o,a;return a=r.children("svg")[0],o=new e(a),t.then(function(t){return o.hover([function(t){return i.$apply(function(){return i.hover(t,null)})},function(){return i.$apply(function(){return i.hover(null,null)})}]),o.click(function(t){return i.$apply(function(){return i.click(t)})}),i.$watch("indicators",function(e){var r,s,u,c;if(null!=e)return c=i.indicators,s=c[0],u=c[1],o.xValue=function(e){return t.getIndicatorValue(e,s)},o.yValue=function(e){return t.getIndicatorValue(e,u)},o.xDomain=function(){return n(t,s)},o.yDomain=function(){return n(t,u)},r=function(e){var n;return n=t.varInfo.get(e),n.Indicator+("("+n.Year+")")},o.xLabel=r(s),o.yLabel=r(u),o.label=function(t){return t},o.data(t.vitalsigns.keys()),i.$watch("active",function(t){return null!=t?d3.select(a).selectAll(".point,.label").classed("active",function(e){return t.length>0&&_(t).every(function(t){return _(e).contains(t)})}):void 0},!0),i.$watch("selected",function(t){return null!=t?d3.select(a).selectAll(".point,.label").classed("selected",function(e){return _(t).contains(e)}):void 0},!0)},!0)})}}}])}.call(this);