(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("vitalsigns",["ui.router"]).config(["$stateProvider","$urlRouterProvider",function(t,e){return t.state("main",{url:"/i/:indicators",templateUrl:"partials/main.tpl.html",controller:"main"}).state("main.multiples",{url:"/",views:{controls:{templateUrl:"partials/controls.tpl.html"},multiples:{templateUrl:"partials/multiples.tpl.html"},comments:{template:""}}}),e.otherwise("/i//")}]).run(["$rootScope",function(t){return t._=_}]).factory("vsData",["$q",function(t){var e,r,n,i;return e=t.defer(),i={topojson:null,codebook:null,vitalsigns:d3.map(),variables:[],varInfo:d3.map()},d3.json("data/csa_2010_boundaries/CSA_NSA_Tracts.topo.json",function(t,r){if(t)throw e.reject(t),new Error(t);return i.topojson=r,d3.csv("data/Vital Signs Codebook and Sources - Variables and Sources.csv",function(t){return t},function(t,r){var n,o,s,a,u,l,c,h,d,p,v,f;if(t)throw e.reject(t),new Error(t);for(i.codebook=r,f=i.codebook,h=0,p=f.length;p>h;h++)for(s=f[h],a=s["Variable Name"],a=a.substring(0,a.length-2),c=function(){var t,e;for(e=[],u=t=2007;2013>=t;u=++t)e.push(u);return e}(),o=function(t,e){return(1e15+t+"").slice(-e)},d=0,v=c.length;v>d;d++)u=c[d],l=o(u-2e3,2),n=angular.extend({Year:u},s),n["Variable Name"]=a+l,i.varInfo.set(a+l,n);return e.resolve(i)})}),n=function(t){var e,r,n;e=t.CSA2010,i.vitalsigns.has(e)||i.vitalsigns.set(e,d3.map());for(r in t)n=t[r],"CSA2010"!==r&&i.vitalsigns.get(e).set(r,n);return t},r=function(t,e){var r,n,o,s;o=e[0],s=[];for(r in o)n=o[r],s.push("CSA2010"!==r?i.variables.push(r):void 0);return s},d3.csv("data/VS Arts 2011-2012 - VS Arts 2010-2012.csv",n,r),d3.csv("data/VS Census 2010-2012 - VS Census 2010-2012.csv",n,r),d3.csv("data/VS Crime 2010-2012 - VS Crime 2010-2012.csv",n,r),d3.csv("data/VS Education 2010-2012 - VS Education 2010-2012.csv",n,r),d3.csv("data/VS Health 2010-2012 - VS_Health_2010-2012.csv",n,r),d3.csv("data/VS Housing 2010-2012 - VS Housing 2010-2012.csv",n,r),d3.csv("data/VS Sustainability 2010-2012 - VS Sustainability 2010-2012.csv",n,r),d3.csv("data/VS Workforce 2010-2012 - VS Workforce 2010-2012.csv",n,r),e.promise}]).factory("Choropleth",["vsData",function(){var e;return e=function(){function e(e,r,n){this.feature=r,this.regionProperty=n,this.redraw=t(this.redraw,this),this.data=t(this.data,this),this.range=t(this.range,this),this.domain=t(this.domain,this),this.value=t(this.value,this),this.hover=t(this.hover,this),this.svg=d3.select(e),this.projection=d3.geo.mercator().scale(5e4).center([-76.6167,39.2833]).translate([this.width/2,this.height/2]),this.path=d3.geo.path().projection(this.projection)}return e.prototype.width=200,e.prototype.height=200,e.prototype._mouseover=function(){},e.prototype._mouseout=function(){},e.prototype.hover=function(t){return null!=t?(this._mouseover=t[0],this._mouseout=t[1],this):[this._mouseover,this._mouseout]},e.prototype.parseValue=function(t){return parseFloat(t)},e.prototype.value=function(t){var e;return this.parseValue(null!=(e=this.regionData.get(t.id))?e.get(this.regionProperty):void 0)},e.prototype.domain=function(){return d3.extent(this.regionData.values(),function(t){return function(e){return t.parseValue(e.get(t.regionProperty))}}(this))},e.prototype.range=function(){return d3.range(9).map(function(t){return"q"+t+"-9"})},e.prototype.data=function(t,e){return this.topojsonData=t,this.regionData=e,this.redraw()},e.prototype.redraw=function(){var t,e;return t=this.topojsonData.objects[this.feature],e=d3.scale.quantize().domain(this.domain()).range(this.range()),this.svg.attr("width",this.width).attr("height",this.height),this.svg.selectAll(".region").data(topojson.feature(this.topojsonData,t).features).enter().append("path").attr("d",this.path).attr("data-region",function(t){return t.id}).attr("class",function(t){return function(r){return e(t.value(r))}}(this)).on("mouseover",function(t){return function(e,r){return t._mouseover(e,r)}}(this)).on("mouseout",function(t){return function(e,r){return t._mouseout(e,r)}}(this)),this.svg.append("path").datum(topojson.mesh(this.topojsonData,t)).attr("d",this.path).attr("class","region-boundary")},e}()}]).directive("vsMap",["vsData","Choropleth",function(t,e){return{template:"<div><svg></svg></div>",restrict:"E",replace:!0,scope:{hover:"="},link:function(r,n,i){return i.$observe("property",function(i){var o,s;return o=n.children("svg")[0],s=new e(o,"CSA_NSA_Tracts",i),t.then(function(t){return r.varInfo=t.varInfo.get(i),s.data(t.topojson,t.vitalsigns),s.hover([function(t){return r.$apply(function(){return r.hover(t.id,i)})},function(){}])})})}}}]).factory("Histogram",["vsData",function(){var e;return e=function(){function e(e,r){this.regionProperty=r,this.redraw=t(this.redraw,this),this.data=t(this.data,this),this.domain=t(this.domain,this),this.value=t(this.value,this),this.hover=t(this.hover,this),this.svg=d3.select(e)}return e.prototype.width=200,e.prototype.height=200,e.prototype._mouseover=function(){},e.prototype._mouseout=function(){},e.prototype.hover=function(t){return null!=t?(this._mouseover=t[0],this._mouseout=t[1],this):[this._mouseover,this._mouseout]},e.prototype.parseValue=function(t){return parseFloat(t)},e.prototype.value=function(t){return this.parseValue(t.get(this.regionProperty))},e.prototype.domain=function(){return d3.extent(this.regionData.values(),this.value)},e.prototype.data=function(t){return this.regionData=t,this.redraw()},e.prototype.redraw=function(){var t,e,r,n,i,o,s,a,u;return i={top:10,right:30,bottom:30,left:30},s=d3.scale.linear().domain(this.domain()).range([0,this.width]),n=d3.layout.histogram().bins(s.ticks(20)).value(this.value),e=n(this.regionData.values()),u=d3.scale.linear().domain([0,d3.max(e,function(){return function(t){return t.y}}(this))]).range([this.height,0]),a=d3.svg.axis().scale(s).orient("bottom"),r=this.svg.attr("width",this.width-i.left-i.right).attr("height",this.height-i.bottom-i.top).append("g").attr("transform","translate("+i.left+","+i.right+")"),t=r.selectAll(".bar").data(e).enter().append("g").attr("class","bar").attr("transform",function(){return function(t){return"translate("+s(t.x)+","+u(t.y)+")"}}(this)),o=t.append("rect").attr("x",1).attr("width",s(e[0].dx)-1).attr("height",function(t){return function(e){return t.height-e.y}}(this)),r.append("g").attr("class","x-axis").attr("transform","translate(0,"+this.height+")").call(a)},e}()}]).directive("vsHistogram",["vsData","Histogram",function(t,e){return{templateUrl:"partials/vs-histogram.tpl.html",restrict:"E",replace:!0,scope:{hover:"="},link:function(r,n,i){return console.log("Hist"),i.$observe("property",function(i){var o,s;return s=n.children("svg")[0],o=new e(s,i),t.then(function(t){return r.varInfo=t.varInfo.get(i),o.data(t.vitalsigns)})})}}}]).controller("main",["$scope","vsData","Selection","$state","$stateParams",function(t,e,r,n,i){return e.then(function(e){return t.vitalsigns=e.vitalsigns,t.varInfo=e.varInfo,t.indicators=_(e.varInfo.values()).filter(function(t){return _.contains(e.variables,t["Variable Name"])}).groupBy("Section").value(),t.selection=new r(i.indicators),t.$watch("selection.toString()",function(t,e){return null!=t||t===e?n.go("main.multiples",{indicators:t}):void 0},!0),t.selectCommunity=function(e,r){return t.currentCommunity=e,t.currentIndicator=r},t.moveLeft=function(e){var r,i;return r=_.indexOf(t.selection.selectedValues,e),i=t.selection.selectedValues[r],t.selection.selectedValues[r]=t.selection.selectedValues[r-1],t.selection.selectedValues[r-1]=i,n.go("main.multiples",{indicators:t.selection.toString()})},t.moveRight=function(e){var r,i;return r=_.indexOf(t.selection.selectedValues,e),i=t.selection.selectedValues[r],t.selection.selectedValues[r]=t.selection.selectedValues[r+1],t.selection.selectedValues[r+1]=i,n.go("main.multiples",{indicators:t.selection.toString()})}})}])}).call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("vitalsigns").factory("Selection",function(){var e;return e=function(){function e(e){this.select=t(this.select,this),this.isSelected=t(this.isSelected,this),this.toggle=t(this.toggle,this),this.remove=t(this.remove,this),this.add=t(this.add,this),this.toString=t(this.toString,this),null!=e&&e.trim().length>0&&(this.selectedValues=e.split(":"))}return e.prototype.selectedValues=[],e.prototype.toString=function(){var t;return(null!=(t=this.selectedValues)?t:[]).join(":")},e.prototype.add=function(t){return this.isSelected(t)?void 0:this.selectedValues.push(t)},e.prototype.remove=function(t){var e;return e=_.indexOf(this.selectedValues,t),e>=0?this.selectedValues.splice(e,1):void 0},e.prototype.toggle=function(t){return this.isSelected(t)?this.remove(t):this.add(t)},e.prototype.isSelected=function(t){return _.contains(this.selectedValues,t)},e.prototype.select=function(t){return _.isArray(t)?void(_.some(t,function(t){return function(e){return!t.isSelected(e)}}(this))?_.map(t,this.add):_.map(t,this.remove)):this.toggle(t)},e}()})}.call(this);