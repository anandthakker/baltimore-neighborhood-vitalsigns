(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};angular.module("vitalsigns",[]).run(["$rootScope",function(t){return t._=_}]).factory("vsData",["$q",function(t){var e,r,n,a;return e=t.defer(),a={topojson:null,codebook:null,vitalsigns:d3.map(),variables:[],varInfo:d3.map()},d3.json("data/csa_2010_boundaries/CSA_NSA_Tracts.topo.json",function(t,r){if(t)throw e.reject(t),new Error(t);return a.topojson=r,d3.csv("data/Vital Signs Codebook and Sources - Variables and Sources.csv",function(t){return t},function(t,r){var n,o,s,i,c,u,l,d,v,f,p,h;if(t)throw e.reject(t),new Error(t);for(a.codebook=r,h=a.codebook,d=0,f=h.length;f>d;d++)for(s=h[d],i=s["Variable Name"],i=i.substring(0,i.length-2),l=function(){var t,e;for(e=[],c=t=2007;2013>=t;c=++t)e.push(c);return e}(),o=function(t,e){return(1e15+t+"").slice(-e)},v=0,p=l.length;p>v;v++)c=l[v],u=o(c-2e3,2),n=angular.extend({Year:c},s),n["Variable Name"]=i+u,a.varInfo.set(i+u,n);return e.resolve(a)})}),n=function(t){var e,r,n;e=t.CSA2010,a.vitalsigns.has(e)||a.vitalsigns.set(e,d3.map());for(r in t)n=t[r],"CSA2010"!==r&&a.vitalsigns.get(e).set(r,n);return t},r=function(t,e){var r,n,o,s;o=e[0],s=[];for(r in o)n=o[r],s.push("CSA2010"!==r?a.variables.push(r):void 0);return s},d3.csv("data/VS Arts 2011-2012 - VS Arts 2010-2012.csv",n,r),d3.csv("data/VS Census 2010-2012 - VS Census 2010-2012.csv",n,r),d3.csv("data/VS Crime 2010-2012 - VS Crime 2010-2012.csv",n,r),d3.csv("data/VS Education 2010-2012 - VS Education 2010-2012.csv",n,r),d3.csv("data/VS Health 2010-2012 - VS_Health_2010-2012.csv",n,r),d3.csv("data/VS Housing 2010-2012 - VS Housing 2010-2012.csv",n,r),d3.csv("data/VS Sustainability 2010-2012 - VS Sustainability 2010-2012.csv",n,r),d3.csv("data/VS Workforce 2010-2012 - VS Workforce 2010-2012.csv",n,r),e.promise}]).factory("choropleth",["vsData",function(t){var e,r,n,a,o;return o=200,r=200,a=d3.geo.mercator(),a.scale(5e4),a.center([-76.6167,39.2833]),a.translate([o/2,r/2]),n=d3.geo.path().projection(a),e=function(e,a){return e=d3.select(e),t.then(function(t){var s,i,c,u,l,d;return c=t.topojson,d=t.vitalsigns,i=c.objects.CSA_NSA_Tracts,l=function(t){return parseFloat(t.get(a))},s=[d3.min(d.values(),l),d3.max(d.values(),l)],u=d3.scale.quantize().domain(s).range(d3.range(9).map(function(t){return"q"+t+"-9"})),e.attr("width",o).attr("height",r).attr("data-property",a).attr("data-min",s[0]).attr("data-max",s[1]),l=function(t){var e,r;return null!=(e=parseFloat(null!=(r=d.get(t.id))?r.get(a):void 0))?e:0},e.selectAll(".community").data(topojson.feature(c,i).features).enter().append("path").attr("data-community",function(t){return t.id}).attr("data-property",l).attr("class",function(t){return u(l(t))}).attr("d",n),e.append("path").datum(topojson.mesh(c,i)).attr("d",n).attr("class","community-boundary")},function(t){return console.error(t)})}}]).directive("vsMap",["vsData","choropleth",function(t,e){return{templateUrl:"partials/vs-map.tpl.html",restrict:"E",replace:!0,link:function(r,n,a){return a.$observe("property",function(a){return t.then(function(t){return e(n.children("svg")[0],a),r.varInfo=t.varInfo.get(a)})})}}}]).factory("Selection",function(){var e;return e=function(){function e(){this.select=t(this.select,this),this.isSelected=t(this.isSelected,this),this.toggle=t(this.toggle,this),this.remove=t(this.remove,this),this.add=t(this.add,this)}return e.prototype.selectedValues=[],e.prototype.add=function(t){return this.isSelected(t)?void 0:this.selectedValues.push(t)},e.prototype.remove=function(t){var e;return e=_.indexOf(this.selectedValues,t),e>=0?this.selectedValues.splice(e,1):void 0},e.prototype.toggle=function(t){return this.isSelected(t)?this.remove(t):this.add(t)},e.prototype.isSelected=function(t){return _.contains(this.selectedValues,t)},e.prototype.select=function(t){return _.isArray(t)?void(_.some(t,function(t){return function(e){return!t.isSelected(e)}}(this))?_.map(t,this.add):_.map(t,this.remove)):this.toggle(t)},e}()}).controller("main",["$scope","vsData","Selection",function(t,e,r){return e.then(function(e){var n;return t.vars=e.variables,n=_.filter(e.varInfo.values(),function(t){return _.contains(e.variables,t["Variable Name"])}),t.indicators=_.groupBy(n,"Section"),t.selection=new r})}])}).call(this);